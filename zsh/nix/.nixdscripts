# Update the pinned 'dotfiles' input in a flake, without changing your cwd.
# Usage: nupd [flake_dir] [dotfiles_dir]
nupd() {
  set -euo pipefail
  local flake_dir="${1:-$HOME/dotfiles/nix}"
  local dot_dir="${2:-$HOME/dotisles}"  # set to $HOME/dotfiles if you want local HEAD shown

  # Read the locked rev for 'dotfiles'
  local locked_rev
  locked_rev="$(nix flake metadata --json "$flake_dir" \
               | jq -r '.locks.nodes.dotfiles.locked.rev // empty')" || locked_rev=""

  # If the input is a local path (no rev), tell the user — nothing to update
  if [[ -z "$locked_rev" ]]; then
    echo "dotfiles input looks like a local path in $flake_dir (no pinned rev)."
    echo "Edits are picked up on rebuild; no lock update needed."
  else
    echo "Currently pinned dotfiles rev: $locked_rev"
  fi

  # (Optional) show your local checkout HEAD if present
  if [[ -d "$dot_dir/.git" ]]; then
    local local_head
    local_head="$(git -C "$dot_dir" rev-parse HEAD 2>/dev/null || true)"
    [[ -n "$local_head" ]] && echo "Local dotfiles HEAD:          $local_head"
  fi

  # Update only the 'dotfiles' input (runs in a subshell; cwd unchanged)
  (
    set -e
    cd "$flake_dir"
    nix flake lock --update-input dotfiles
    local new_rev
    new_rev="$(nix flake metadata --json . | jq -r '.locks.nodes.dotfiles.locked.rev // empty')"
    [[ -n "$new_rev" ]] && echo "Updated dotfiles input →       $new_rev"
  )
}
